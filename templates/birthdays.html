{% extends "base.html" %}

{% block title %}Anniversaires des Membres - Club Clermont{% endblock %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10 col-12">
            <div class="bg-white p-4 shadow rounded text-center">
                <h1 class="text-primary mb-3">Anniversaires des Membres</h1>
                
                <div class="d-flex justify-content-center mb-3 d-none d-md-flex">
                    <label class="switch">
                        <input type="checkbox" id="toggle-view">
                        <span class="slider round"></span>
                    </label>
                    <span class="ms-2" id="toggle-label">Afficher Calendrier</span>
                </div>
                
                <div id="list-container">
                    <ul id="birthday-list" class="list-group"></ul>
                </div>
                <div id="calendar-container" class="d-none">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- FullCalendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch("/get_birthdays");
                const data = await response.json();

                const today = new Date();
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(today.getDate() - 7);

                let recentBirthdays = [];
                let upcomingBirthdays = [];
                let events = [];

                data.filter(member => member.birthday).forEach(member => {
                    const birthdayDate = new Date(member.birthday);
                    const birthYear = birthdayDate.getFullYear();
                    const ageAtBirthday = today.getFullYear() - birthYear;

                    // Calcul de la date d'anniversaire pour cette annÃ©e
                    let formattedDate = new Date(today.getFullYear(), birthdayDate.getMonth(), birthdayDate.getDate());
                    const dateString = formattedDate.toISOString().split('T')[0]; // Format YYYY-MM-DD

                    // VÃ©rifier si l'anniversaire Ã©tait dans la derniÃ¨re semaine
                    const isRecentBirthday = formattedDate >= oneWeekAgo && formattedDate < today;

                    // Ajouter dans les Ã©vÃ©nements pour le calendrier
                    events.push({
                        title: `ðŸŽ‚ ${member.nom}`,
                        start: dateString,
                        extendedProps: { 
                            age: ageAtBirthday,
                            fullDate: birthdayDate.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long' })
                        },
                        backgroundColor: isRecentBirthday ? "#FFA500" : (dateString.slice(5) === today.toISOString().slice(5, 10) ? "#DC3545" : "#1E3A8A"),
                        textColor: "white",
                    });

                    // CrÃ©ation de l'Ã©lÃ©ment pour la liste
                    let li = document.createElement("li");
                    li.classList.add("list-group-item");
                    li.textContent = `ðŸŽ‚ ${member.nom} (${ageAtBirthday} ans) - ${birthdayDate.toLocaleDateString('fr-FR', { day: '2-digit', month: 'long' })}`;

                    if (isRecentBirthday) {
                        li.textContent += " (Anniversaire rÃ©cent ðŸŽ‰)";
                        li.style.color = "#FFA500";
                        recentBirthdays.push({ date: formattedDate, element: li });
                    } else if (formattedDate >= today) {
                        upcomingBirthdays.push({ date: formattedDate, element: li });
                    }
                });

                // Trier les anniversaires rÃ©cents (du plus ancien au plus rÃ©cent)
                recentBirthdays.sort((a, b) => a.date - b.date);
                // Trier les anniversaires futurs (du plus proche au plus Ã©loignÃ©)
                upcomingBirthdays.sort((a, b) => a.date - b.date);

                // Nettoyer la liste et ajouter les anniversaires dans le bon ordre
                const listContainer = document.getElementById("birthday-list");
                listContainer.innerHTML = "";
                recentBirthdays.forEach(item => listContainer.appendChild(item.element));
                upcomingBirthdays.forEach(item => listContainer.appendChild(item.element));

                // Initialiser le calendrier FullCalendar avec tooltip au survol
                const calendarEl = document.getElementById("calendar");
                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: "dayGridMonth",
                    locale: "fr",
                    events: events,
                    height: "auto",
                    contentHeight: "auto",
                    aspectRatio: 2,
                    headerToolbar: {
                        left: "prev,next today",
                        center: "title",
                        right: "dayGridMonth,timeGridWeek,timeGridDay"
                    },
                    buttonText: {
                        today: "Aujourd'hui",
                        month: "Mois",
                        week: "Semaine",
                        day: "Jour"
                    },
                    eventMouseEnter: function(info) { 
                        let tooltip = document.createElement("div");
                        tooltip.classList.add("custom-tooltip");
                        tooltip.innerHTML = `<strong>${info.event.title}</strong><br>ðŸ“… ${info.event.extendedProps.fullDate}<br>ðŸŽ‰ ${info.event.extendedProps.age} ans`;
                        document.body.appendChild(tooltip);

                        tooltip.style.position = "absolute";
                        tooltip.style.background = "#333";
                        tooltip.style.color = "#fff";
                        tooltip.style.padding = "8px";
                        tooltip.style.borderRadius = "5px";
                        tooltip.style.boxShadow = "2px 2px 5px rgba(0,0,0,0.3)";
                        tooltip.style.pointerEvents = "none";
                        tooltip.style.zIndex = "1000";

                        function moveTooltip(e) {
                            tooltip.style.left = e.pageX + 10 + "px";
                            tooltip.style.top = e.pageY + 10 + "px";
                        }

                        document.addEventListener("mousemove", moveTooltip);

                        info.el.addEventListener("mouseleave", () => {
                            tooltip.remove();
                            document.removeEventListener("mousemove", moveTooltip);
                        });
                    }
                });
                calendar.render();

                // Gestion du switch Liste/Calendrier
                document.getElementById("toggle-view").addEventListener("change", (event) => {
                    const calendarContainer = document.getElementById("calendar-container");
                    const listContainer = document.getElementById("list-container");
                    const label = document.getElementById("toggle-label");

                    if (event.target.checked) {
                        calendarContainer.classList.remove("d-none");
                        listContainer.classList.add("d-none");
                        label.textContent = "Afficher Liste";
                        setTimeout(() => calendar.updateSize(), 300);
                    } else {
                        calendarContainer.classList.add("d-none");
                        listContainer.classList.remove("d-none");
                        label.textContent = "Afficher Calendrier";
                    }
                });

                // Par dÃ©faut : afficher la liste
                document.getElementById("toggle-view").checked = false;
                document.getElementById("calendar-container").classList.add("d-none");
                document.getElementById("list-container").classList.remove("d-none");
                document.getElementById("toggle-label").textContent = "Afficher Calendrier";

            } catch (error) {
                console.error("Erreur lors du chargement des anniversaires :", error);
            }
        });
    </script>
{% endblock %}
